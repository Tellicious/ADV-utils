/* BEGIN Header */
/**
 ******************************************************************************
 * \file            test_PID.c
 * \author          Andrea Vivani
 * \brief           Unit tests for PID.c
 ******************************************************************************
 * \copyright
 *
 * Copyright 2024 Andrea Vivani
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *
 ******************************************************************************
 */
/* END Header */

/* Includes ------------------------------------------------------------------*/

#include <setjmp.h>
#include <stdarg.h>
#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include "PID.h"

#include <cmocka.h>

/* Macros --------------------------------------------------------------------*/
#define NUM_DATA 111

/* Private variables ---------------------------------------------------------*/
static float input[NUM_DATA] = {
    0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,
    13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13,
    -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, 13,  13,  13,  13,  13,  13,  13,  13,  13,
    13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  13,  -13, -13, -13, -13, -13, -13, -13,
    -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, -13, 13};

/* Functions -----------------------------------------------------------------*/
static void test_PID_init(void** state) {
    (void)state; /* unused */

    PID_t pid;
    PID_init(&pid, 1.0f, 1.0f, 1.0f, 1.0f, 0.5f, 1000.0f, -10.0f, 10.0f);

    assert_float_equal(pid.kp, 1.0f, 1e-5);
    assert_float_equal(pid.ki, 0.5f * 1.0f * 1000.0f * 1e-3f, 1e-5);
    assert_float_equal(pid.kd, (2 * 1.0f * 1.0f) / (2 + 1.0f * 1000.0f * 1e-3f), 1e-5);
    assert_float_equal(pid.nd, 1.0f, 1e-5);
    assert_float_equal(pid.dT, 1000.0f * 1e-3f, 1e-5);
    assert_float_equal(pid.satMin, -10.0f, 1e-5);
    assert_float_equal(pid.satMax, 10.0f, 1e-5);
    assert_float_equal(pid.kb, 0.5f * 0.5f * 1000.0f * 1e-3f, 1e-5);
    assert_float_equal(pid.kf, (2 - 1.0f * 1000.0f * 1e-3) / (2 + 1.0f * 1000.0f * 1e-3), 1e-5);
}

static void test_PID_calc(void** state) {
    (void)state; /* unused */
    PID_t pid;

    float PID_true[NUM_DATA] = {
        0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  6.26167,
        6.07389,  6.27130,  6.59710,  6.96570,  7.34857,  7.73619,  8.12540,  8.51513,  8.90504,  9.29501,  9.68500,
        10.07500, 10.46500, 10.85500, 11.24500, 11.63500, 12.02500, 12.41500, 12.80500, 13.19500, 13.58500, 13.97500,
        14.36500, 14.75500, 2.62167,  3.38722,  3.38241,  3.12080,  2.77360,  2.39787,  2.01262,  1.62421,  1.23474,
        0.84491,  0.45497,  0.06499,  -0.32500, -0.71500, -1.10500, -1.49500, -1.88500, -2.27500, -2.66500, -3.05500,
        -3.44500, -3.83500, -4.22500, -4.61500, -5.00500, 7.12833,  6.36278,  6.36759,  6.62920,  6.97640,  7.35213,
        7.73738,  8.12579,  8.51526,  8.90509,  9.29503,  9.68501,  10.07500, 10.46500, 10.85500, 11.24500, 11.63500,
        12.02500, 12.41500, 12.80500, 13.19500, 13.58500, 13.97500, 14.36500, 14.75500, 2.62167,  3.38722,  3.38241,
        3.12080,  2.77360,  2.39787,  2.01262,  1.62421,  1.23474,  0.84491,  0.45497,  0.06499,  -0.32500, -0.71500,
        -1.10500, -1.49500, -1.88500, -2.27500, -2.66500, -3.05500, -3.44500, -3.83500, -4.22500, -4.61500, -5.00500,
        7.12833};

    PID_init(&pid, 0.4f, 0.3f, 0.01f, 10.0f, 0.0f, 100.0f, -100.0f, 100.0f);

    for (uint8_t ii = 0; ii < NUM_DATA; ii++) {
        PID_calc(&pid, input[ii], 0);
        assert_float_equal(PID_getOutput(&pid), PID_true[ii], 1e-5);
    }
}

static void test_PID_calcAeroClamp(void** state) {
    (void)state; /* unused */
    PID_t pid;

    float PID_true[NUM_DATA] = {
        0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  6.26167,
        6.07389,  6.27130,  6.59710,  6.96570,  7.34857,  7.73619,  8.12540,  8.51513,  8.90504,  9.29501,  9.68500,
        10.07500, 10.46500, 10.85500, 11.24500, 11.63500, 12.02500, 12.20000, 12.20000, 12.20000, 12.20000, 12.20000,
        12.20000, 12.20000, -0.12833, 0.63722,  0.63241,  0.37080,  0.02360,  -0.35213, -0.73738, -1.12579, -1.51526,
        -1.90509, -2.29503, -2.68501, -3.07500, -3.46500, -3.85500, -4.24500, -4.63500, -5.02500, -5.41500, -5.80500,
        -6.19500, -6.58500, -6.97500, -7.36500, -7.75500, 4.37833,  3.61278,  3.61759,  3.87920,  4.22640,  4.60213,
        4.98738,  5.37579,  5.76526,  6.15509,  6.54503,  6.93501,  7.32500,  7.71500,  8.10500,  8.49500,  8.88500,
        9.27500,  9.66500,  10.05500, 10.44500, 10.83500, 11.22500, 11.61500, 12.00500, -0.12833, 0.63722,  0.63241,
        0.37080,  0.02360,  -0.35213, -0.73738, -1.12579, -1.51526, -1.90509, -2.29503, -2.68501, -3.07500, -3.46500,
        -3.85500, -4.24500, -4.63500, -5.02500, -5.41500, -5.80500, -6.19500, -6.58500, -6.97500, -7.36500, -7.75500,
        4.37833};

    PID_init(&pid, 0.4f, 0.3f, 0.01f, 10.0f, 0.0f, 100.0f, -7.0f, 7.0f);

    for (uint8_t ii = 0; ii < NUM_DATA; ii++) {
        utilsStatus_t retVal = PID_calcAeroClamp(&pid, input[ii], 0);
        if ((PID_getOutput(&pid) == 7.0) || (PID_getOutput(&pid) == -7.0)) {
            assert_int_equal(retVal, UTILS_STATUS_FULL);
        }
        assert_float_equal(PID_getOutput(&pid), PID_true[ii], 1e-5);
    }
}

static void test_PID_calcIntegralClamp(void** state) {
    (void)state; /* unused */
    PID_t pid;

    float PID_true[NUM_DATA] = {
        0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  6.26167,
        6.07389,  6.27130,  6.59710,  6.96570,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  -5.17833, -4.41278, -4.41759, -4.67920, -5.02640, -5.40213, -5.78738, -6.17579, -6.56526,
        -6.95509, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, 5.17833,  4.41278,  4.41759,  4.67920,  5.02640,  5.40213,
        5.78738,  6.17579,  6.56526,  6.95509,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  -5.17833, -4.41278, -4.41759,
        -4.67920, -5.02640, -5.40213, -5.78738, -6.17579, -6.56526, -6.95509, -7.00000, -7.00000, -7.00000, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        5.17833};

    PID_init(&pid, 0.4f, 0.3f, 0.01f, 10.0f, 0.0f, 100.0f, -7.0f, 7.0f);

    for (uint8_t ii = 0; ii < NUM_DATA; ii++) {
        utilsStatus_t retVal = PID_calcIntegralClamp(&pid, input[ii], 0);
        if ((PID_getOutput(&pid) == 7.0) || (PID_getOutput(&pid) == -7.0)) {
            assert_int_equal(retVal, UTILS_STATUS_FULL);
        }
        assert_float_equal(PID_getOutput(&pid), PID_true[ii], 1e-5);
    }
}

static void test_PID_calcBackCalc(void** state) {
    (void)state; /* unused */
    PID_t pid;

    /* Result of true BC algorithm from MATLAB */
    /* float PID_true[NUM_DATA] = {
        0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  6.26167,
        6.07389,  6.27130,  6.59710,  6.96570,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  -3.41089, -2.64533, -2.65015, -2.91175, -3.25895, -3.63469, -4.01993, -4.40835, -4.79782,
        -5.18764, -5.57758, -5.96756, -6.35756, -6.74755, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, 3.59913,  2.83357,  2.83839,  3.09999,  3.44720,  3.82293,
        4.20817,  4.59659,  4.98606,  5.37588,  5.76583,  6.15581,  6.54580,  6.93580,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  -3.57843, -2.81287, -2.81768,
        -3.07929, -3.42649, -3.80222, -4.18747, -4.57588, -4.96536, -5.35518, -5.74512, -6.13510, -6.52510, -6.91509,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        3.58070}; */

    /* Result of algorithm with delayed BC from MATLAB */
    /* float PID_true[NUM_DATA] = {
        0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  6.26167,
        6.07389,  6.27130,  6.59710,  6.96570,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  -3.58211, -3.01041, -3.01523, -3.27683, -3.62404, -3.99977, -4.38501, -4.77343, -5.16290,
        -5.55272, -5.94267, -6.33265, -6.72264, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, 3.65631,  3.07498,  3.07979,  3.34140,  3.68860,  4.06433,
        4.44958,  4.83799,  5.22746,  5.61729,  6.00723,  6.39721,  6.78720,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  -3.65292, -3.07203, -3.07685,
        -3.33845, -3.68566, -4.06139, -4.44663, -4.83505, -5.22452, -5.61434, -6.00429, -6.39427, -6.78426, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        3.65308}; */

    float PID_true[NUM_DATA] = {
        0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  0.00000,  6.26167,
        6.07389,  6.27130,  6.59710,  6.96570,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  -3.77597, -3.01041, -3.01523, -3.27683, -3.62404, -3.99977, -4.38501, -4.77343, -5.16290,
        -5.55272, -5.94267, -6.33265, -6.72264, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, 3.84053,  3.07498,  3.07979,  3.34140,  3.68860,  4.06433,
        4.44958,  4.83799,  5.22746,  5.61729,  6.00723,  6.39721,  6.78720,  7.00000,  7.00000,  7.00000,  7.00000,
        7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  7.00000,  -3.83759, -3.07203, -3.07685,
        -3.33845, -3.68566, -4.06139, -4.44663, -4.83505, -5.22452, -5.61435, -6.00429, -6.39427, -6.78426, -7.00000,
        -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000, -7.00000,
        3.83772};

    PID_init(&pid, 0.4f, 0.3f, 0.01f, 10.0f, 2.0f, 100.0f, -7.0f, 7.0f);

    for (uint8_t ii = 0; ii < NUM_DATA; ii++) {
        utilsStatus_t retVal = PID_calcBackCalc(&pid, input[ii], 0);
        if ((PID_getOutput(&pid) == 7.0) || (PID_getOutput(&pid) == -7.0)) {
            assert_int_equal(retVal, UTILS_STATUS_FULL);
        }
        assert_float_equal(PID_getOutput(&pid), PID_true[ii], 1e-5);
    }
}

int main(void) {
    const struct CMUnitTest tests[] = {
        cmocka_unit_test(test_PID_init),          cmocka_unit_test(test_PID_calc),
        cmocka_unit_test(test_PID_calcAeroClamp), cmocka_unit_test(test_PID_calcIntegralClamp),
        cmocka_unit_test(test_PID_calcBackCalc),
    };

    return cmocka_run_group_tests(tests, NULL, NULL);
}
